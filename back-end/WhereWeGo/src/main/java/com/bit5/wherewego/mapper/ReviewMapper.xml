<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bit5.wherewego.review.ReviewDAOImp">

	<!-- 리뷰리스트 -->
	<select id="reviewAllSelect"
		resultType="com.bit5.wherewego.review.ReviewVO">
	<![CDATA[ 
		 select * from 
		(select * from 
		(select r.r_num, r.score, r.info, to_char(r.writedate, 'MM/DD') writedate, r.grade, r.photo, r.res_num, rr.c_num, rr.userid, rr.name, to_char(rr.resdate, 'MM/DD') resdate
		from review r 
		join (select re.resdate resdate, re.res_num res_num, re.userid userid, re.c_num c_num, c.name name from res re join course c on re.c_num=c.c_num) rr 
		on r.res_num=rr.res_num 
		order by r_num desc)  
		where rownum<=#{param1} order by r_num asc) 
		where rownum<=#{param2} order by r_num desc
		]]>
	</select>
	
	<!-- 코스명 검색 리스트 -->
	<select id="allSelectSearchname"
		resultType="com.bit5.wherewego.review.ReviewVO">
	<![CDATA[ 
		 select * from 
		(select * from 
		(select r.r_num, r.score, r.info, to_char(r.writedate, 'MM/DD') writedate, r.grade, r.photo, r.res_num, rr.c_num, rr.userid, rr.name, to_char(rr.resdate, 'MM/DD') resdate
		from review r 
		join (select re.resdate resdate, re.res_num res_num, re.userid userid, re.c_num c_num, c.name name from res re join course c on re.c_num=c.c_num and name like '%'||#{param3}||'%') rr 
		on r.res_num=rr.res_num 
		order by r_num desc)  
		where rownum<=#{param1} order by r_num asc) 
		where rownum<=#{param2} order by r_num desc
		]]>
	</select>
	
	<!-- 작성자 검색 리뷰리스트 -->
	<select id="allSelectSearchid"
		resultType="com.bit5.wherewego.review.ReviewVO">
	<![CDATA[ 
		 select * from 
		(select * from 
		(select r.r_num, r.score, r.info, to_char(r.writedate, 'MM/DD') writedate, r.grade, r.photo, r.res_num, rr.c_num, rr.userid, rr.name, to_char(rr.resdate, 'MM/DD') resdate
		from review r 
		join (select re.resdate resdate, re.res_num res_num, re.userid userid, re.c_num c_num, c.name name from res re join course c on re.c_num=c.c_num and userid like '%'||#{param3}||'%') rr 
		on r.res_num=rr.res_num 
		order by r_num desc)  
		where rownum<=#{param1} order by r_num asc) 
		where rownum<=#{param2} order by r_num desc
		]]>
	</select>

	<!-- 리뷰리스트 페이징 -->
	<select id="totalRecordCount" resultType="int">
		select count(r_num) totalRecord from review
	</select>
	
	<!-- 코스명 검색 리뷰리스트 페이징 -->
	<select id="totalSearchname" resultType="int">
		select count(v.r_num) from review v join 
		(select r.res_num, r.c_num, c.name from res r join course c on r.c_num=c.c_num) n
		on v.res_num=n.res_num and name like '%'||#{param1}||'%'
	</select>
	
	<!-- 작성자 검색 리뷰리스트 페이징 -->
	<select id="totalSearchid" resultType="int">
		select count(r_num) from review r join res s on r.res_num=s.res_num
		and userid like '%'||#{param1}||'%'
	</select>

	<!-- 베스트리뷰 -->
	<select id="selectBestReviews"
		resultType="com.bit5.wherewego.review.ReviewVO">
    select r.r_num r_num, r.score score, r.info info, to_char(r.writedate,'YY/MM/DD') writedate, r.photo photo, n.name name, n.userid userid, to_char(n.resdate,'YY/MM/DD') resdate, r.grade grade 
		from review r 
		join (select e.res_num, c.name, e.userid, e.resdate from res e join course c on e.c_num=c.c_num) n 
		on r.res_num=n.res_num and r.grade='공개' order by r.score desc , r.writedate asc
	</select>

	<!-- 새로운리뷰카운트 -->
	<select id="newReviewCount" resultType="int">
		select count(r_num)
		newReview from review where to_char(writedate,'YY/MM/DD') = to_char(sysdate,'YY/MM/DD')
	</select>
	
	<!-- 내가 작성한 리뷰 -->
	<select id="myReviewSelect" resultType="com.bit5.wherewego.review.ReviewVO">
		select r.r_num r_num, r.score score, r.info info, to_char(r.writedate,'YY/MM/DD') writedate, r.photo photo, n.name name, n.userid userid, to_char(n.resdate,'YY/MM/DD') resdate, r.grade grade 
		from review r 
		join (select e.res_num, c.name, e.userid, e.resdate from res e join course c on e.c_num=c.c_num) n 
		on r.res_num=n.res_num and userid=#{param1} order by r.writedate asc
	</select>
	
	<!-- 리뷰 보기 -->
	<select id="reviewView" resultType="com.bit5.wherewego.review.ReviewVO">
	  select r.r_num, r.score, r.info, r.writedate, r.photo, n.name, n.userid, to_char(n.resdate,'YY/MM/DD') resdate, r.grade 
      from review r 
      join (select e.res_num, c.name, e.userid, e.resdate from res e join course c on e.c_num=c.c_num) n 
      on r.res_num=n.res_num and r_num=#{param1} order by r.writedate asc
	</select>
	<!-- 공개 비공개 -->
	<update id="reViewgradech" parameterType="com.bit5.wherewego.review.ReviewVO">
		update review set
		<if test='grade.equals("공개")'>grade='비공개'</if>
		<if test='grade.equals("비공개")'>grade='공개'</if>
		where r_num=${r_num} 
		
	</update>

</mapper>
